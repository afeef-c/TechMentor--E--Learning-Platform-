import React, { createContext, useState, useEffect } from 'react';
import axios from 'axios';
import { decodeToken } from '../utils/decodeToken'; // Assuming you have a decodeToken utility
import { ACCESS_TOKEN, REFRESH_TOKEN } from "../constants";
import api from '../api';


const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [authTokens, setAuthTokens] = useState(() => localStorage.getItem('authTokens') ? JSON.parse(localStorage.getItem('authTokens')) : null);
//  const [user, setUser] = useState(() => localStorage.getItem('authTokens') ? decodeToken(localStorage.getItem('authTokens')).access : null);
  const [user, setUser] = useState(() => localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')) : null);
  console.log(user)
  const loginUser = async (username, password) => {
    try {
      
      const res = await api.post("/users/login/", { username, password });
      if (res.data) {
        //setAuthTokens(response.data);
        //setUser(decodeToken(response.data.access));
        //localStorage.setItem('authTokens', JSON.stringify(response.data));
        //localStorage.setItem('user', JSON.stringify(decodedUser));
        localStorage.setItem(ACCESS_TOKEN, res.data.access);
        localStorage.setItem(REFRESH_TOKEN, res.data.refresh);
        console.log(res.data)
        
        navigate("/")

      }
    } catch (error) {
      console.error('Login failed:', error);
      navigate("/login")
    }
  };

  const registerUser = async (username, email, password, userType) => {
    try {
      const res = await api.post('/users/register/', { username, email, password, user_type: userType });
      if (res.data) {
        //setAuthTokens(response.data);
        //setUser(decodeToken(response.data.access));
        //localStorage.setItem('authTokens', JSON.stringify(response.data));
        //localStorage.setItem('user', JSON.stringify(decodedUser));
        localStorage.setItem(ACCESS_TOKEN, res.data.access);
        localStorage.setItem(REFRESH_TOKEN, res.data.refresh);
        console.log("Registered!!")
        console.log(res.data)
        navigate("/")

      }
    } 
    catch (error) {
      console.error('Registration failed:', error);
      navigate("/register")
    }
  };

  const logoutUser = () => {
    setAuthTokens(null);
    setUser(null);
    localStorage.removeItem('authTokens');
    localStorage.removeItem('user');
  };

  const fetchUserDetails = async () => {
    if (authTokens) {
      try {
        const response = await axios.get('http://localhost:8000/users/profile/', {
          headers: {
            Authorization: `Bearer ${authTokens.access}`
          }
        });
        setUser(response.data);
      } catch (error) {
        console.error('Failed to fetch user details:', error);
      }
    }
  };

  useEffect(() => {
    if (authTokens) {
      setUser(decodeToken(authTokens.access));
      fetchUserDetails();
    }
  }, [authTokens]);

  const contextData = {
    user,
    authTokens,
    loginUser,
    registerUser,
    logoutUser,
    fetchUserDetails
  };

  return (
    <AuthContext.Provider value={contextData}>
      {children}
    </AuthContext.Provider>
  );
};

export default AuthContext;
